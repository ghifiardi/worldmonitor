apiVersion: gatra/v1
kind: Playbook
metadata:
  name: credential-compromise
  displayName: Credential Compromise Investigation
  description: >
    Investigates compromised credentials — checks dark web exposure, analyzes
    authentication logs for abuse, detects post-compromise lateral movement,
    and recommends account containment actions.
  author: GATRA SOC
  version: "1.0"
  tags:
    - credentials
    - account-compromise
    - dark-web
    - identity
    - ueba
  mitre:
    tactics:
      - TA0006  # Credential Access
      - TA0008  # Lateral Movement
      - TA0003  # Persistence
      - TA0005  # Defense Evasion
    techniques:
      - T1078      # Valid Accounts
      - T1110      # Brute Force
      - T1555      # Credentials from Password Stores
      - T1539      # Steal Web Session Cookie
      - T1550.002  # Pass the Hash
      - T1021      # Remote Services
  severity: HIGH
  estimatedMinutes: 20
  category: investigate

spec:
  variables:
    - name: account_details
      type: string
      description: Affected accounts, email addresses, or usernames
      required: true

  steps:
    - id: identify_accounts
      name: Identify Compromised Accounts
      description: >
        Provide details of the suspected compromised accounts — usernames,
        email addresses, how the compromise was detected (alert, dark web
        notification, user report, MFA bypass attempt).
      agent: ada
      action: "Analyze these potentially compromised accounts: {{account_details}}"
      input:
        source: analyst
        prompt: "Enter compromised account details (usernames, emails, detection source):"
      output:
        name: account_analysis
        format: text
      onFailure: continue

    - id: dark_web_check
      name: Dark Web & Breach Database Check
      description: >
        TAA checks dark web markets, paste sites, and breach databases for
        the compromised credentials. Identifies if credentials were sold,
        dumped, or part of a larger breach.
      agent: taa
      action: >
        Check dark web and breach databases for these compromised accounts.
        Search: dark web marketplaces, paste sites (Pastebin, Ghostbin),
        stealer logs (Raccoon, RedLine, Vidar), breach compilation databases,
        Telegram credential channels.
        Determine: when credentials were first exposed, source of the breach,
        number of times credentials appear, associated data (passwords,
        session tokens, cookies).
        Account details: {{account_analysis}}
      output:
        name: dark_web_findings
        format: text
      onFailure: continue

    - id: auth_log_analysis
      name: "Authentication Log Analysis (UEBA)"
      description: >
        ADA performs User Entity Behavior Analytics on authentication logs —
        impossible travel, unusual login times, new device/location,
        MFA bypass attempts, and password spray patterns.
      agent: ada
      action: >
        Perform UEBA analysis on authentication logs for compromised accounts.
        Detect: impossible travel (logins from geographically distant locations
        within short timeframe), unusual login hours, new device fingerprints,
        MFA challenge failures followed by successes, legacy protocol usage
        (IMAP, POP3 bypassing MFA), concurrent sessions from different IPs,
        password spray patterns across multiple accounts.
        Dark web intel: {{dark_web_findings}}
        Accounts: {{account_analysis}}
      output:
        name: auth_analysis
        format: text
      onFailure: continue

    - id: post_compromise
      name: Post-Compromise Activity Detection
      description: >
        ADA investigates what the attacker did after gaining access —
        email forwarding rules, data access, privilege escalation,
        lateral movement to other systems.
      agent: ada
      action: >
        Detect post-compromise activity for the compromised accounts.
        Check: email forwarding/redirect rules created, mailbox export or
        delegation changes, SharePoint/OneDrive mass downloads, Azure AD
        role assignments, OAuth app consents, service principal creation,
        lateral movement to other systems, data exfiltration indicators.
        Auth analysis: {{auth_analysis}}
        Accounts: {{account_analysis}}
      output:
        name: post_compromise
        format: text
      onFailure: continue

    - id: account_containment
      name: Account Containment
      description: >
        CRA recommends account containment actions. Analyst must approve
        before credential resets and session revocations are executed.
      agent: cra
      action: >
        Recommend containment actions for compromised accounts.
        Priority actions: force password reset, revoke all active sessions
        and refresh tokens, revoke OAuth app consents, remove suspicious
        email forwarding rules, enforce MFA re-registration, block legacy
        auth protocols, review and remove unauthorized role assignments.
        Post-compromise: {{post_compromise}}
        Auth analysis: {{auth_analysis}}
        Dark web: {{dark_web_findings}}
      input:
        source: analyst
        prompt: "Review containment actions. Type 'approve' to execute or describe modifications:"
      output:
        name: containment_actions
        format: text
      onFailure: continue

    - id: report
      name: Credential Compromise Report
      description: >
        CLA generates a credential compromise investigation report with
        timeline, impact, and remediation recommendations.
      agent: cla
      action: >
        Generate a credential compromise investigation report.
        Include: Executive Summary, Affected Accounts, Dark Web Exposure,
        Authentication Anomalies (UEBA Findings), Post-Compromise Activity,
        Containment Actions, Password Policy Recommendations, and
        Identity Security Improvement Plan.
        Accounts: {{account_analysis}}
        Dark web: {{dark_web_findings}}
        Auth: {{auth_analysis}}
        Post-compromise: {{post_compromise}}
        Containment: {{containment_actions}}
      output:
        name: investigation_report
        format: text
      onFailure: continue
