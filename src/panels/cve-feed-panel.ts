/**
 * CVEFeedPanel — Real-time CVE / Vulnerability feed panel.
 *
 * Renders:
 *   1. Header stats row (total CVEs, critical count, exploited-in-wild count)
 *   2. Scrollable CVE list with severity badges, KEV indicators, and timeAgo
 *
 * Data sourced from NVD API v2 and cross-referenced with CISA KEV catalog
 * via the cve-feed service. Refreshes every 10 minutes.
 */

import { Panel } from '@/components/Panel';
import { escapeHtml } from '@/utils/sanitize';
import { fetchCVEFeed } from '@/services/cve-feed';
import type { CVEItem, CVESeverity } from '@/types';

// ── Severity color mapping ──────────────────────────────────────────

const SEV_COLORS: Record<CVESeverity, string> = {
  CRITICAL: '#ef4444',
  HIGH: '#f97316',
  MEDIUM: '#eab308',
  LOW: '#3b82f6',
  NONE: '#6b7280',
};

// ── Panel class ─────────────────────────────────────────────────────

export class CVEFeedPanel extends Panel {
  private cves: CVEItem[] = [];
  private loading = false;
  private lastFetchTime: Date | null = null;

  constructor() {
    super({
      id: 'cve-feed',
      title: 'CVE Feed',
      showCount: true,
      trackActivity: true,
      infoTooltip:
        'Real-time CVE vulnerability data from NVD (NIST) cross-referenced with CISA Known Exploited Vulnerabilities catalog. Data refreshes every 10 min.',
    });
  }

  /** Called by App on a scheduled interval. */
  public async refresh(): Promise<void> {
    if (this.loading) return;
    this.loading = true;

    try {
      const items = await fetchCVEFeed();
      this.cves = items;
      this.lastFetchTime = new Date();

      this.setCount(items.length);
      const critCount = items.filter((c) => c.severity === 'CRITICAL').length;
      const kevCount = items.filter((c) => c.exploitedInWild).length;
      const detail = critCount > 0 ? `${critCount} critical` : `${items.length} CVEs`;
      this.setDataBadge('live', detail);

      if (kevCount > 0) {
        this.setNewBadge(kevCount, true);
      } else {
        this.clearNewBadge();
      }

      this.render();
    } catch (err) {
      console.error('[CVEFeedPanel] refresh error:', err);
      if (this.cves.length === 0) {
        this.showError('Failed to load CVE data');
      }
      this.setDataBadge('unavailable');
    } finally {
      this.loading = false;
    }
  }

  /** Expose CVE items for other consumers. */
  public getCVEs(): CVEItem[] {
    return this.cves;
  }

  // ── Rendering ─────────────────────────────────────────────────────

  private render(): void {
    const html = [
      this.renderStatsRow(),
      this.renderCVEList(),
      this.renderFooter(),
    ].join('');

    this.setContent(html);
  }

  // ── Stats row ─────────────────────────────────────────────────────

  private renderStatsRow(): string {
    const total = this.cves.length;
    const critical = this.cves.filter((c) => c.severity === 'CRITICAL').length;
    const high = this.cves.filter((c) => c.severity === 'HIGH').length;
    const kevCount = this.cves.filter((c) => c.exploitedInWild).length;

    const stat = (label: string, value: number, color?: string) =>
      `<div style="text-align:center;flex:1;min-width:55px;">
        <div style="font-size:18px;font-weight:700;${color ? `color:${color};` : 'color:var(--text-primary);'}">${value}</div>
        <div style="font-size:10px;opacity:0.5;text-transform:uppercase;letter-spacing:0.3px;">${label}</div>
      </div>`;

    return `<div style="display:flex;padding:10px 12px;border-bottom:1px solid var(--border-dim);gap:6px;">
      ${stat('Total', total)}
      ${stat('Critical', critical, critical > 0 ? '#ef4444' : undefined)}
      ${stat('High', high, high > 0 ? '#f97316' : undefined)}
      ${stat('Exploited', kevCount, kevCount > 0 ? '#ef4444' : undefined)}
    </div>`;
  }

  // ── CVE list ──────────────────────────────────────────────────────

  private renderCVEList(): string {
    if (this.cves.length === 0) {
      return '<div style="padding:12px;opacity:0.5;font-size:12px;">No CVEs available</div>';
    }

    const rows = this.cves.map((cve) => {
      const sevColor = SEV_COLORS[cve.severity] || '#6b7280';
      const ts = this.timeAgo(cve.publishedDate);

      // CVSS badge
      const scoreBadge = cve.cvssScore !== null
        ? `<span style="background:${sevColor};color:#fff;font-size:10px;font-weight:700;padding:1px 6px;border-radius:3px;flex-shrink:0;">${cve.cvssScore.toFixed(1)}</span>`
        : `<span style="background:#374151;color:#9ca3af;font-size:10px;font-weight:700;padding:1px 6px;border-radius:3px;flex-shrink:0;">N/A</span>`;

      // KEV badge (pulsing red)
      const kevBadge = cve.exploitedInWild
        ? `<span style="background:#ef4444;color:#fff;font-size:9px;font-weight:700;padding:1px 5px;border-radius:3px;flex-shrink:0;animation:cve-kev-pulse 1.5s ease-in-out infinite;" title="CISA Known Exploited Vulnerability">KEV</span>`
        : '';

      // CWE badge
      const cweBadge = cve.cweId
        ? `<span style="opacity:0.5;font-size:10px;">${escapeHtml(cve.cweId)}</span>`
        : '';

      // Truncated description (2 lines via CSS)
      const desc = escapeHtml(cve.description);

      // Affected products
      const products = cve.affectedProducts.length > 0
        ? `<div style="opacity:0.4;margin-top:2px;font-size:10px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${cve.affectedProducts.map(p => escapeHtml(p)).join(' · ')}</div>`
        : '';

      return `<div style="padding:6px 12px;border-bottom:1px solid var(--border-dim);font-size:12px;">
        <div style="display:flex;align-items:center;gap:6px;margin-bottom:3px;">
          ${scoreBadge}
          <span style="font-family:'SF Mono',SFMono-Regular,Consolas,'Liberation Mono',Menlo,monospace;font-weight:600;font-size:11px;color:var(--text-primary);">${escapeHtml(cve.id)}</span>
          ${kevBadge}
          ${cweBadge}
          <span style="margin-left:auto;opacity:0.4;flex-shrink:0;font-size:10px;">${ts}</span>
        </div>
        <div style="opacity:0.7;font-size:11px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;line-height:1.4;">${desc}</div>
        ${products}
      </div>`;
    }).join('');

    return `<div style="max-height:400px;overflow-y:auto;">
      <div style="padding:6px 12px;font-size:10px;text-transform:uppercase;letter-spacing:0.5px;opacity:0.5;border-bottom:1px solid var(--border-dim);">Latest Vulnerabilities</div>
      ${rows}
    </div>
    <style>
      @keyframes cve-kev-pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }
    </style>`;
  }

  // ── Footer ────────────────────────────────────────────────────────

  private renderFooter(): string {
    const sourceInfo = this.lastFetchTime
      ? `Updated ${this.timeAgo(this.lastFetchTime)}`
      : 'Loading...';

    return `<div style="padding:6px 12px;font-size:10px;opacity:0.35;display:flex;justify-content:space-between;border-top:1px solid var(--border-dim);">
      <span>Source: NVD + CISA KEV</span>
      <span>${escapeHtml(sourceInfo)}</span>
    </div>`;
  }

  // ── Helpers ───────────────────────────────────────────────────────

  private timeAgo(date: Date): string {
    const ms = Date.now() - date.getTime();
    if (ms < 60_000) return 'just now';
    if (ms < 3_600_000) return `${Math.floor(ms / 60_000)}m ago`;
    if (ms < 86_400_000) return `${Math.floor(ms / 3_600_000)}h ago`;
    return `${Math.floor(ms / 86_400_000)}d ago`;
  }
}
