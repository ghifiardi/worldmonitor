---
phase: 05-humanity-data-panels
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/progress-data.ts
  - src/components/ProgressChartsPanel.ts
  - package.json
autonomous: true
requirements:
  - PROG-01
  - PROG-02
  - PROG-03

must_haves:
  truths:
    - "ProgressChartsPanel displays 4 D3.js area charts: life expectancy rising, literacy rising, child mortality dropping, extreme poverty declining"
    - "Progress chart data is fetched from World Bank Indicators API via existing getIndicatorData() RPC"
    - "Charts render with warm happy-theme colors (sage green, soft blue, warm gold, muted rose)"
    - "Charts show clear positive trends with area fill and smooth curve rendering"
  artifacts:
    - path: "src/services/progress-data.ts"
      provides: "Progress data fetching and normalization from World Bank API"
      exports: ["fetchProgressData", "ProgressDataSet", "PROGRESS_INDICATORS"]
    - path: "src/components/ProgressChartsPanel.ts"
      provides: "Panel component with 4 D3.js area charts showing humanity improving"
      exports: ["ProgressChartsPanel"]
  key_links:
    - from: "src/services/progress-data.ts"
      to: "src/services/economic/index.ts"
      via: "imports getIndicatorData for World Bank API proxy"
      pattern: "import.*getIndicatorData.*economic"
    - from: "src/components/ProgressChartsPanel.ts"
      to: "src/services/progress-data.ts"
      via: "imports fetchProgressData for chart data"
      pattern: "import.*from.*progress-data"
    - from: "src/components/ProgressChartsPanel.ts"
      to: "src/components/Panel.ts"
      via: "extends Panel base class"
      pattern: "extends Panel"
---

<objective>
Create the progress data service and D3.js area chart panel showing humanity getting better over decades.

Purpose: Deliver compelling visual proof that the world is improving -- life expectancy rising, literacy increasing, child mortality plummeting, extreme poverty declining. These long-term trend charts are the intellectual counterpart to the emotional counters, providing data-backed optimism.

Output: `src/services/progress-data.ts` (World Bank data fetching) and `src/components/ProgressChartsPanel.ts` (Panel subclass with 4 D3 area charts).
</objective>

<execution_context>
@/Users/sebastienmelki/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastienmelki/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-humanity-data-panels/05-RESEARCH.md
@src/components/Panel.ts
@src/components/PositiveNewsFeedPanel.ts
@src/services/economic/index.ts
@src/components/CountryTimeline.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install papaparse and create progress data service with World Bank fetching</name>
  <files>src/services/progress-data.ts, package.json</files>
  <action>
**Step 1: Install papaparse** (new dependency per roadmap decision):
```bash
npm install papaparse && npm install -D @types/papaparse
```

**Step 2: Create `src/services/progress-data.ts`:**

1. **Types:**
   ```typescript
   export interface ProgressDataPoint {
     year: number;
     value: number;
   }

   export interface ProgressIndicator {
     id: string;
     code: string;         // World Bank indicator code
     label: string;
     unit: string;         // e.g., "years", "%", "per 1,000"
     color: string;        // CSS color from happy theme
     years: number;        // How many years of data to fetch
     invertTrend: boolean; // true for metrics where DOWN is good (mortality, poverty)
   }

   export interface ProgressDataSet {
     indicator: ProgressIndicator;
     data: ProgressDataPoint[];
     latestValue: number;
     oldestValue: number;
     changePercent: number; // Positive = improvement (accounts for invertTrend)
   }
   ```

2. **PROGRESS_INDICATORS constant array** with 4 indicators:
   - `lifeExpectancy`: code `SP.DYN.LE00.IN`, years 65, color `#6B8F5E` (sage green), unit "years", invertTrend false
   - `literacy`: code `SE.ADT.LITR.ZS`, years 55, color `#7BA5C4` (soft blue), unit "%", invertTrend false
   - `childMortality`: code `SH.DYN.MORT`, years 65, color `#C4A35A` (warm gold), unit "per 1,000", invertTrend true
   - `poverty`: code `SI.POV.DDAY`, years 45, color `#C48B9F` (muted rose), unit "%", invertTrend true

3. **fetchProgressData(): Promise<ProgressDataSet[]>** function:
   - Import `getIndicatorData` from `@/services/economic`
   - For each indicator, call `getIndicatorData(indicator.code, { countries: ['1W'], years: indicator.years })`
   - Parse response: extract year/value pairs, filter out null/undefined values
   - Sort by year ascending
   - Calculate latestValue, oldestValue, and changePercent
   - For invertTrend indicators, negate the change direction so positive changePercent always means "improvement"
   - Return all 4 ProgressDataSets
   - Wrap in try/catch -- if World Bank API fails, return empty arrays (graceful degradation)

4. **Important notes:**
   - The existing `getIndicatorData()` uses a circuit breaker and returns `WorldBankResponse` type -- inspect `src/services/economic/index.ts` for the exact response shape and map accordingly
   - The `WorldBankResponse.data` array contains objects with `.date` (string year) and `.value` (number | null)
   - Filter out entries where value is null before building ProgressDataPoint[]
   - papaparse is installed for potential OWID fallback but NOT used in the primary flow -- World Bank via existing RPC is the primary source for all 4 indicators
  </action>
  <verify>
Run `npm ls papaparse` to confirm installation. Run `npx tsc --noEmit` to verify no type errors. Check that progress-data.ts imports from `@/services/economic` correctly.
  </verify>
  <done>
papaparse installed as dependency. `progress-data.ts` exports PROGRESS_INDICATORS (4 indicators with World Bank codes and warm colors), fetchProgressData() that fetches world-level data via existing getIndicatorData() RPC, and ProgressDataSet/ProgressIndicator types. Null values filtered, data sorted by year, change percentages calculated.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ProgressChartsPanel with D3.js area charts for 4 human progress indicators</name>
  <files>src/components/ProgressChartsPanel.ts</files>
  <action>
Create `src/components/ProgressChartsPanel.ts` extending the Panel base class:

1. **Class structure:**
   ```typescript
   import { Panel } from './Panel';
   import * as d3 from 'd3';
   import { type ProgressDataSet } from '@/services/progress-data';
   ```
   - Constructor: `super({ id: 'progress', title: 'Human Progress', trackActivity: false })`

2. **Public `setData(datasets: ProgressDataSet[]): void`** method:
   - Clear existing charts from `this.content`
   - For each dataset, call `renderChart()` to create an area chart
   - If datasets is empty, show a loading/empty state message

3. **Private `renderChart(dataset: ProgressDataSet): void`** method:
   - Create a chart container div with class `progress-chart-container`
   - Add a header row with: label, change badge (e.g., "+58% since 1960"), and unit
   - Create SVG using D3:
     - Margins: `{ top: 8, right: 12, bottom: 24, left: 40 }`
     - Width: container width minus margins (use `this.content.clientWidth - 32` as approximate, or measure container)
     - Height: 90px (compact sparkline-ish area charts)
     - X scale: `d3.scaleLinear()` with domain from min to max year
     - Y scale: `d3.scaleLinear()` with domain from data min to max (with 10% padding)
     - Area generator: `d3.area()` with `.curve(d3.curveMonotoneX)` for smooth curves
     - Line generator: `d3.line()` with same curve for the top edge
   - Render:
     - Filled area path with `fill: indicator.color` at 0.2 opacity
     - Stroke line on top with `stroke: indicator.color` at 2px width
     - X axis at bottom with ~4-5 tick marks showing years
     - Y axis at left with ~3 tick marks showing values
     - Axis text color: use `var(--text-secondary)` from CSS or a muted gray
   - Add hover tooltip:
     - On mousemove over the chart area, find nearest data point using `d3.bisector`
     - Show a tooltip div with year and exact value (positioned near cursor)
     - On mouseleave, hide tooltip

4. **Responsive handling:**
   - Store a ResizeObserver on `this.content`
   - On resize, re-render all charts (debounce with 200ms timeout)
   - Clean up observer in `destroy()`

5. **Lifecycle:**
   - `destroy()`: disconnect ResizeObserver, remove SVG elements, call `super.destroy()`

6. **Chart colors from happy theme (research-verified):**
   - Life expectancy: `#6B8F5E` (sage green)
   - Literacy: `#7BA5C4` (soft blue)
   - Child mortality: `#C4A35A` (warm gold)
   - Extreme poverty: `#C48B9F` (muted rose)

7. **Important implementation notes:**
   - Use `d3.curveMonotoneX` for smooth curves that pass through all data points
   - For invertTrend charts (mortality, poverty), the trend line goes DOWN but this is presented as positive (the change badge shows a positive improvement %)
   - Axes should use abbreviated formatting: years as 4-digit, values with appropriate unit suffix
   - The panel shows 4 charts stacked vertically in a scrollable area
   - Follow the D3 patterns from `src/components/CountryTimeline.ts` for consistency
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no type errors. Verify ProgressChartsPanel extends Panel, has setData() method accepting ProgressDataSet[], and creates D3 SVG area charts.
  </verify>
  <done>
ProgressChartsPanel extends Panel, displays 4 D3.js area charts (life expectancy, literacy, child mortality, extreme poverty) with warm happy-theme colors. Each chart has a label, change badge, filled area with semi-transparent color, stroke line, axes, and hover tooltip. ResizeObserver handles responsive re-rendering. Charts use d3.curveMonotoneX for smooth curves.
  </done>
</task>

</tasks>

<verification>
1. `npm ls papaparse` shows papaparse installed
2. `npx tsc --noEmit` passes with no errors
3. `src/services/progress-data.ts` exports PROGRESS_INDICATORS (4 entries), fetchProgressData, ProgressDataSet type
4. `src/components/ProgressChartsPanel.ts` exports ProgressChartsPanel extending Panel
5. Progress data uses existing getIndicatorData() from economic service (no new API endpoints)
6. Charts use D3 area() with curveMonotoneX
7. 4 chart colors match happy theme warm palette
8. ResizeObserver wired for responsive charts
</verification>

<success_criteria>
The progress data service fetches 4 world-level indicators from World Bank via the existing sebuf RPC. The ProgressChartsPanel renders 4 stacked D3.js area charts with smooth curves, warm colors, change badges, and hover tooltips -- visually proving that life expectancy is rising, literacy is increasing, child mortality is plummeting, and extreme poverty is declining.
</success_criteria>

<output>
After completion, create `.planning/phases/05-humanity-data-panels/05-02-SUMMARY.md`
</output>
