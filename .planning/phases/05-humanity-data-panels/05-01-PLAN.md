---
phase: 05-humanity-data-panels
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/humanity-counters.ts
  - src/components/CountersPanel.ts
autonomous: true
requirements:
  - COUNT-01
  - COUNT-02
  - COUNT-03

must_haves:
  truths:
    - "CountersPanel displays 6 ticking counters: babies born, trees planted, vaccines administered, students graduated, books published, renewable MW installed"
    - "Counter values are derived from per-second rates calculated from annual UN/WHO/World Bank totals"
    - "Counters tick smoothly at 60fps via requestAnimationFrame, creating a hypnotic always-moving feel"
    - "Counter values calculate from absolute time (seconds since midnight UTC * rate) to avoid drift"
  artifacts:
    - path: "src/services/humanity-counters.ts"
      provides: "Counter metric definitions with annual totals, per-second rates, and value calculation"
      exports: ["COUNTER_METRICS", "getCounterValue", "CounterMetric"]
    - path: "src/components/CountersPanel.ts"
      provides: "Panel component with 6 animated ticking counters"
      exports: ["CountersPanel"]
  key_links:
    - from: "src/components/CountersPanel.ts"
      to: "src/services/humanity-counters.ts"
      via: "imports COUNTER_METRICS and getCounterValue"
      pattern: "import.*from.*humanity-counters"
    - from: "src/components/CountersPanel.ts"
      to: "src/components/Panel.ts"
      via: "extends Panel base class"
      pattern: "extends Panel"
---

<objective>
Create the Worldometer-style ticking counters service and panel component for the happy variant.

Purpose: Deliver the "hypnotic, always-moving" live counter experience showing positive global metrics ticking in real time. This is the most animation-heavy component in the happy variant but requires zero API calls -- all data is derived from hardcoded annual rates.

Output: `src/services/humanity-counters.ts` (counter rate definitions and value calculation) and `src/components/CountersPanel.ts` (Panel subclass with 60fps animated counters).
</objective>

<execution_context>
@/Users/sebastienmelki/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastienmelki/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-humanity-data-panels/05-RESEARCH.md
@src/components/Panel.ts
@src/components/PositiveNewsFeedPanel.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create humanity counters service with metric definitions and rate calculations</name>
  <files>src/services/humanity-counters.ts</files>
  <action>
Create `src/services/humanity-counters.ts` with:

1. **CounterMetric interface:**
   ```typescript
   export interface CounterMetric {
     id: string;
     label: string;
     annualTotal: number;
     source: string;
     perSecondRate: number;
     icon: string;           // Emoji icon
     formatPrecision: number; // Decimal places for display
   }
   ```

2. **COUNTER_METRICS constant array** with 6 metrics (annual totals from UN/WHO/World Bank):
   - `births`: 135,600,000/yr (~4.3/sec), icon 'ðŸ‘¶', precision 0
   - `trees`: 15,300,000,000/yr (~485/sec), icon 'ðŸŒ³', precision 0
   - `vaccines`: 4,600,000,000/yr (~146/sec), icon 'ðŸ’‰', precision 0
   - `graduates`: 70,000,000/yr (~2.2/sec), icon 'ðŸŽ“', precision 0
   - `books`: 2,200,000/yr (~0.07/sec), icon 'ðŸ“š', precision 0
   - `renewable`: 510,000 MW/yr (~0.016/sec), icon 'âš¡', precision 2
   - Calculate `perSecondRate` as `annualTotal / 31_536_000`

3. **getCounterValue(metric: CounterMetric): number** function:
   - Calculate seconds elapsed since midnight UTC today
   - Return `metric.perSecondRate * elapsedSeconds`
   - This is absolute-time based (not delta accumulation) to avoid drift across tabs/throttling

4. **formatCounterValue(value: number, precision: number): string** function:
   - Use `Intl.NumberFormat` with locale `'en-US'` for thousands separators
   - Apply `minimumFractionDigits` and `maximumFractionDigits` from precision parameter
   - This gives clean formatting like "372,891" or "8.23"

Add source attribution comments on each annual total (e.g., "UN Population Division WPP 2024").
  </action>
  <verify>
Run `npx tsc --noEmit src/services/humanity-counters.ts` (or broader `npx tsc --noEmit`) to verify no type errors. Verify all 6 metrics have perSecondRate > 0 and correct precision.
  </verify>
  <done>
`humanity-counters.ts` exports COUNTER_METRICS (6 metrics), getCounterValue (absolute-time calculation), formatCounterValue (Intl.NumberFormat), and CounterMetric type. All per-second rates are pre-calculated from annual totals divided by 31,536,000.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CountersPanel component with 60fps animated ticking numbers</name>
  <files>src/components/CountersPanel.ts</files>
  <action>
Create `src/components/CountersPanel.ts` extending the Panel base class:

1. **Class structure:**
   ```typescript
   import { Panel } from './Panel';
   import { COUNTER_METRICS, getCounterValue, formatCounterValue, type CounterMetric } from '@/services/humanity-counters';
   ```
   - Constructor: `super({ id: 'counters', title: 'Live Counters', trackActivity: false })`
   - No `showCount` -- counters panel doesn't need a count badge

2. **DOM structure** (created in constructor, appended to `this.content`):
   - For each of the 6 metrics, create a counter card:
     ```html
     <div class="counter-card">
       <div class="counter-icon">{emoji}</div>
       <div class="counter-value" data-counter="{id}">{initial value}</div>
       <div class="counter-label">{label}</div>
       <div class="counter-source">{source}</div>
     </div>
     ```
   - Store references to value elements in a Map<string, HTMLElement> for fast 60fps updates

3. **Animation loop** using requestAnimationFrame:
   - Private `animFrameId: number | null = null`
   - Private `tick()` method using arrow function for correct `this` binding:
     - For each metric: compute `getCounterValue(metric)` and update the DOM element's `textContent` via `formatCounterValue()`
     - Use `textContent` (NOT `innerHTML`) to avoid layout thrashing at 60fps
     - Schedule next frame: `this.animFrameId = requestAnimationFrame(this.tick)`
   - Public `startTicking()`: starts the rAF loop
   - The loop calculates value from absolute time each frame (no delta accumulation)

4. **Lifecycle:**
   - Public `destroy()`: cancel `animFrameId` via `cancelAnimationFrame`, call `super.destroy()`
   - Counter wrapper div gets class `counters-grid` for CSS grid layout

5. **Important implementation notes:**
   - Do NOT use `innerHTML` for counter value updates -- `textContent` only for 60fps performance
   - The value elements should have `font-variant-numeric: tabular-nums` applied via CSS class to prevent layout shift as digits change
   - Start ticking immediately in constructor (or provide startTicking for App.ts to call)
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no type errors. Verify CountersPanel extends Panel, has startTicking() and destroy() methods, and stores 6 counter value DOM elements.
  </verify>
  <done>
CountersPanel component extends Panel, renders 6 counter cards with emoji icons, labels, and source attribution. The requestAnimationFrame loop updates all 6 counter values at 60fps using textContent (no innerHTML). Values are calculated from absolute time via getCounterValue() to avoid drift. startTicking() begins animation, destroy() cancels it.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `src/services/humanity-counters.ts` exports COUNTER_METRICS with 6 entries, getCounterValue, formatCounterValue
3. `src/components/CountersPanel.ts` exports CountersPanel extending Panel
4. CountersPanel creates 6 counter card DOM elements in a grid
5. Animation uses requestAnimationFrame (not setInterval)
6. Counter values use absolute-time calculation (seconds since midnight UTC * rate)
7. DOM updates use textContent (not innerHTML)
</verification>

<success_criteria>
The counter service defines 6 positive metrics with per-second rates derived from annual UN/WHO/World Bank data. The CountersPanel renders these as a grid of ticking numbers animated at 60fps via requestAnimationFrame, using absolute-time value calculation to prevent drift.
</success_criteria>

<output>
After completion, create `.planning/phases/05-humanity-data-panels/05-01-SUMMARY.md`
</output>
