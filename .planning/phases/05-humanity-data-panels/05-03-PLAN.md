---
phase: 05-humanity-data-panels
plan: 03
type: execute
wave: 2
depends_on:
  - 05-01
  - 05-02
files_modified:
  - src/App.ts
  - src/styles/happy-theme.css
autonomous: true
requirements:
  - COUNT-01
  - COUNT-03
  - PROG-03

must_haves:
  truths:
    - "CountersPanel is instantiated and registered in App.ts panels map for happy variant"
    - "ProgressChartsPanel is instantiated and registered in App.ts panels map for happy variant"
    - "Progress chart data is loaded during refreshAll() and passed to ProgressChartsPanel.setData()"
    - "Counters start ticking on app initialization and stop on destroy"
    - "Both panels have CSS styles in happy-theme.css matching the warm color palette"
    - "Counter grid layout is responsive (3 columns on desktop, 2 on tablet, 1 on mobile)"
  artifacts:
    - path: "src/App.ts"
      provides: "Panel instantiation, data loading, and lifecycle wiring for counters and progress panels"
      contains: "CountersPanel|ProgressChartsPanel"
    - path: "src/styles/happy-theme.css"
      provides: "CSS styles for counter cards and progress chart containers"
      contains: "counters-grid|progress-chart-container"
  key_links:
    - from: "src/App.ts"
      to: "src/components/CountersPanel.ts"
      via: "import and instantiate CountersPanel"
      pattern: "import.*CountersPanel"
    - from: "src/App.ts"
      to: "src/components/ProgressChartsPanel.ts"
      via: "import and instantiate ProgressChartsPanel"
      pattern: "import.*ProgressChartsPanel"
    - from: "src/App.ts"
      to: "src/services/progress-data.ts"
      via: "import fetchProgressData for data loading"
      pattern: "import.*fetchProgressData"
---

<objective>
Wire the counters and progress panels into App.ts and add CSS styles to happy-theme.css.

Purpose: Connect the two new panel components (built in Plans 01 and 02) into the application lifecycle -- panel creation, data loading, animation start/stop, and visual styling. This plan completes the full integration loop so both panels appear on the happy variant dashboard.

Output: Updated `src/App.ts` with panel wiring, updated `src/styles/happy-theme.css` with counter and chart styles.
</objective>

<execution_context>
@/Users/sebastienmelki/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastienmelki/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-humanity-data-panels/05-RESEARCH.md
@.planning/phases/05-humanity-data-panels/05-01-SUMMARY.md
@.planning/phases/05-humanity-data-panels/05-02-SUMMARY.md
@src/App.ts
@src/styles/happy-theme.css
@src/config/panels.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire CountersPanel and ProgressChartsPanel into App.ts lifecycle</name>
  <files>src/App.ts</files>
  <action>
Wire both new panels into App.ts following the exact same pattern as PositiveNewsFeedPanel (line ~2404):

**1. Add imports** (near other panel imports at top of file):
```typescript
import { CountersPanel } from '@/components/CountersPanel';
import { ProgressChartsPanel } from '@/components/ProgressChartsPanel';
import { fetchProgressData } from '@/services/progress-data';
```

**2. Add class properties** (near other panel properties):
```typescript
private countersPanel?: CountersPanel;
private progressPanel?: ProgressChartsPanel;
```

**3. Panel instantiation** in `setupPanels()` (right after the PositiveNewsFeedPanel block at ~line 2407):
```typescript
// Counters Panel (happy variant only)
if (SITE_VARIANT === 'happy') {
  this.countersPanel = new CountersPanel();
  this.panels['counters'] = this.countersPanel;
  this.countersPanel.startTicking();
}

// Progress Charts Panel (happy variant only)
if (SITE_VARIANT === 'happy') {
  this.progressPanel = new ProgressChartsPanel();
  this.panels['progress'] = this.progressPanel;
}
```

**4. Data loading** in `refreshAll()` method (near the happy variant task blocks at ~line 3185):
```typescript
// Progress charts data (happy variant only)
if (SITE_VARIANT === 'happy') {
  tasks.push({
    name: 'progress',
    task: runGuarded('progress', () => this.loadProgressData()),
  });
  // Counters don't need a load task -- they tick from hardcoded rates
}
```

**5. Add `loadProgressData()` private method:**
```typescript
private async loadProgressData(): Promise<void> {
  const datasets = await fetchProgressData();
  this.progressPanel?.setData(datasets);
}
```

**6. Cleanup** -- if App.ts has a destroy/cleanup method, ensure:
- `this.countersPanel?.destroy()` is called (stops rAF loop)
- `this.progressPanel?.destroy()` is called (disconnects ResizeObserver)

**Important notes:**
- Follow the additive-only pattern: all changes gated by `SITE_VARIANT === 'happy'`
- CountersPanel starts ticking immediately on creation (no data load needed)
- ProgressChartsPanel gets data asynchronously via loadProgressData()
- The panels are already registered in HAPPY_PANELS config (panels.ts line 396-397) so the grid will include them
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no type errors. Grep for `CountersPanel` and `ProgressChartsPanel` in App.ts to confirm both are imported, instantiated, and registered.
  </verify>
  <done>
App.ts creates CountersPanel and ProgressChartsPanel for happy variant, registers them in the panels map, starts counter ticking, loads progress data during refreshAll(), and cleans up on destroy. All changes are gated behind SITE_VARIANT === 'happy' checks.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add counter and progress chart CSS styles to happy-theme.css</name>
  <files>src/styles/happy-theme.css</files>
  <action>
Append CSS styles to the end of `src/styles/happy-theme.css` for both new panels. All styles scoped under `[data-variant='happy']` selector:

**1. Counters Grid Layout:**
```css
[data-variant='happy'] .counters-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
  padding: 12px;
}

@media (max-width: 900px) {
  [data-variant='happy'] .counters-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (max-width: 500px) {
  [data-variant='happy'] .counters-grid {
    grid-template-columns: 1fr;
  }
}
```

**2. Counter Card Styling:**
```css
[data-variant='happy'] .counter-card {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: var(--panel-radius, 14px);
  padding: 16px;
  text-align: center;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

[data-variant='happy'] .counter-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

[data-variant='happy'] .counter-icon {
  font-size: 1.8rem;
  margin-bottom: 6px;
}

[data-variant='happy'] .counter-value {
  font-size: 1.6rem;
  font-weight: 700;
  font-variant-numeric: tabular-nums;
  color: var(--text);
  line-height: 1.2;
  min-height: 1.6em; /* Prevent layout shift */
}

[data-variant='happy'] .counter-label {
  font-size: 0.8rem;
  font-weight: 600;
  color: var(--text-secondary);
  margin-top: 4px;
  text-transform: uppercase;
  letter-spacing: 0.03em;
}

[data-variant='happy'] .counter-source {
  font-size: 0.65rem;
  color: var(--text-tertiary, var(--text-secondary));
  margin-top: 4px;
  opacity: 0.7;
}
```

**3. Progress Chart Container:**
```css
[data-variant='happy'] .progress-chart-container {
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
}

[data-variant='happy'] .progress-chart-container:last-child {
  border-bottom: none;
}

[data-variant='happy'] .progress-chart-header {
  display: flex;
  align-items: baseline;
  justify-content: space-between;
  margin-bottom: 8px;
}

[data-variant='happy'] .progress-chart-label {
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--text);
}

[data-variant='happy'] .progress-chart-badge {
  font-size: 0.7rem;
  font-weight: 600;
  padding: 2px 8px;
  border-radius: 10px;
  background: var(--green);
  color: white;
}

[data-variant='happy'] .progress-chart-unit {
  font-size: 0.7rem;
  color: var(--text-secondary);
  margin-left: 6px;
}
```

**4. D3 Chart SVG Styling:**
```css
[data-variant='happy'] .progress-chart-container svg {
  overflow: visible;
}

[data-variant='happy'] .progress-chart-container .tick text {
  fill: var(--text-secondary);
  font-size: 0.65rem;
}

[data-variant='happy'] .progress-chart-container .tick line,
[data-variant='happy'] .progress-chart-container .domain {
  stroke: var(--border);
}

[data-variant='happy'] .progress-chart-tooltip {
  position: absolute;
  pointer-events: none;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 4px 8px;
  font-size: 0.7rem;
  color: var(--text);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  z-index: 10;
  white-space: nowrap;
}
```

**5. Dark mode adjustments (compound selector):**
```css
[data-variant='happy'][data-theme='dark'] .counter-card:hover {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
}

[data-variant='happy'][data-theme='dark'] .progress-chart-tooltip {
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}
```

**Important notes:**
- All selectors scoped with `[data-variant='happy']` to avoid affecting other variants
- Use existing CSS variables (--bg, --bg-secondary, --text, --text-secondary, --border, --green, --panel-radius) from happy-theme.css
- `font-variant-numeric: tabular-nums` on counter-value is critical for preventing layout jitter at 60fps
- Dark mode uses compound `[data-variant='happy'][data-theme='dark']` selector per Phase 1 convention
  </action>
  <verify>
Run `npx vite build` (or at minimum `npx tsc --noEmit`) to verify no CSS parse errors. Visually inspect that all selectors are scoped under `[data-variant='happy']`. Verify `font-variant-numeric: tabular-nums` is present on `.counter-value`.
  </verify>
  <done>
happy-theme.css has complete styles for both panels: counters grid (3/2/1 column responsive), counter cards (hover effects, tabular-nums, emoji icons), progress chart containers (stacked with borders), D3 SVG axis styling, hover tooltips, and dark mode adjustments. All selectors scoped under [data-variant='happy'].
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. App.ts imports CountersPanel, ProgressChartsPanel, and fetchProgressData
3. Both panels created inside `SITE_VARIANT === 'happy'` guard
4. CountersPanel.startTicking() called during panel setup
5. loadProgressData() added as a happy-variant task in refreshAll()
6. happy-theme.css contains .counters-grid, .counter-card, .counter-value, .progress-chart-container styles
7. All CSS selectors scoped under [data-variant='happy']
8. counter-value has font-variant-numeric: tabular-nums
9. Responsive grid breakpoints at 900px and 500px
10. Run `npm run build` to verify full build succeeds
</verification>

<success_criteria>
Both CountersPanel and ProgressChartsPanel are fully wired into the happy variant App.ts lifecycle -- created on init, data loaded during refresh, animation started/stopped correctly. CSS styles provide a warm, polished visual treatment with responsive counter grid, hover effects, smooth chart styling, and dark mode support. The happy variant dashboard now shows live ticking counters and human progress charts.
</success_criteria>

<output>
After completion, create `.planning/phases/05-humanity-data-panels/05-03-SUMMARY.md`
</output>
