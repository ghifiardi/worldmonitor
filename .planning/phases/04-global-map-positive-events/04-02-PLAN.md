---
phase: 04-global-map-positive-events
plan: 02
type: execute
wave: 2
depends_on: [04-01]
files_modified:
  - proto/worldmonitor/positive_events/v1/service.proto
  - proto/worldmonitor/positive_events/v1/list_positive_geo_events.proto
  - server/worldmonitor/positive-events/v1/handler.ts
  - server/worldmonitor/positive-events/v1/list-positive-geo-events.ts
  - api/[domain]/v1/[rpc].ts
  - vite.config.ts
  - src/services/positive-events-geo.ts
  - src/components/DeckGLMap.ts
  - src/App.ts
autonomous: true
requirements: [MAP-01, MAP-02]

must_haves:
  truths:
    - "The map displays geocoded positive news events as green/gold pulsing markers on the happy variant"
    - "Positive events are geolocated from two sources: GDELT GEO API (server-side RPC) and RSS geocoding via inferGeoHubsFromTitle"
    - "Clicking a positive event marker shows a tooltip with name, category, and report count"
    - "Positive events layer respects the positiveEvents toggle (can be turned off)"
    - "Data loads asynchronously without blocking the initial map render"
    - "GDELT GEO API calls go through server-side RPC handler (not client-side), consistent with codebase convention"
  artifacts:
    - path: "proto/worldmonitor/positive_events/v1/service.proto"
      provides: "Proto service definition for PositiveEventsService with ListPositiveGeoEvents RPC"
      contains: "ListPositiveGeoEvents"
    - path: "server/worldmonitor/positive-events/v1/list-positive-geo-events.ts"
      provides: "Server-side GDELT GEO fetch with positive topic queries, dedup, classification"
      exports: ["listPositiveGeoEvents"]
    - path: "src/services/positive-events-geo.ts"
      provides: "Client-side service calling server RPC + RSS geocoding"
      exports: ["fetchPositiveGeoEvents", "PositiveGeoEvent", "geocodePositiveNewsItems"]
    - path: "src/components/DeckGLMap.ts"
      provides: "createPositiveEventsLayers method, tooltip case, setter, buildLayers wiring"
      contains: "createPositiveEventsLayers"
    - path: "src/App.ts"
      provides: "Happy variant data loading that calls fetchPositiveGeoEvents and sets map data"
      contains: "setPositiveEvents"
  key_links:
    - from: "src/services/positive-events-geo.ts"
      to: "server/worldmonitor/positive-events/v1/list-positive-geo-events.ts"
      via: "sebuf client RPC call to server handler"
      pattern: "listPositiveGeoEvents"
    - from: "src/services/positive-events-geo.ts"
      to: "src/components/DeckGLMap.ts"
      via: "App.ts calls fetchPositiveGeoEvents() then map.setPositiveEvents()"
      pattern: "setPositiveEvents"
    - from: "src/components/DeckGLMap.ts"
      to: "buildLayers"
      via: "mapLayers.positiveEvents check gates createPositiveEventsLayers()"
      pattern: "mapLayers\\.positiveEvents"
---

<objective>
Build the positive events geocoding pipeline (server-side RPC for GDELT GEO + client-side RSS geocoding) and Deck.gl map layer so users see green/gold pulsing markers at locations of positive news stories.

Purpose: MAP-01 and MAP-02 -- the core value proposition of Phase 4. Positive news events become spatial, showing WHERE good things happen. GDELT GEO fetch goes through server-side RPC per codebase convention (all external API calls use server-side handlers).
Output: Working positive events layer on happy map with server-side GDELT GEO data + client-side RSS geocoding.
</objective>

<execution_context>
@/Users/sebastienmelki/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastienmelki/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-global-map-positive-events/04-RESEARCH.md
@.planning/phases/04-global-map-positive-events/04-01-SUMMARY.md
@proto/worldmonitor/unrest/v1/service.proto (proto service pattern)
@proto/worldmonitor/unrest/v1/list_unrest_events.proto (proto message pattern)
@server/worldmonitor/unrest/v1/handler.ts (handler wiring pattern)
@server/worldmonitor/unrest/v1/list-unrest-events.ts (lines 108-180 -- GDELT GEO fetch pattern)
@api/[domain]/v1/[rpc].ts (route registration pattern)
@vite.config.ts (lines 270-340 -- server module imports + route registration)
@src/components/DeckGLMap.ts (lines 2107-2167 -- createHotspotsLayers pulse pattern)
@src/components/DeckGLMap.ts (lines 2255-2327 -- createNewsLocationsLayer pattern)
@src/components/DeckGLMap.ts (lines 2329-2380 -- getTooltip switch)
@src/components/DeckGLMap.ts (lines 913-970 -- buildLayers layer checks)
@src/components/DeckGLMap.ts (lines 3340-3400 -- setter methods: setNewsLocations pattern)
@src/components/DeckGLMap.ts (lines 2192-2254 -- pulse animation: pulseTime, syncPulseAnimation)
@src/services/geo-hub-index.ts (inferGeoHubsFromTitle)
@src/services/positive-classifier.ts (HappyContentCategory, classifyNewsItem)
@src/services/gdelt-intel.ts (POSITIVE_GDELT_TOPICS)
@src/App.ts (lines 3139-3205 -- loadAllData task pipeline)
@src/App.ts (lines 3590-3635 -- loadHappySupplementaryAndRender pipeline)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create server-side RPC for GDELT GEO positive queries, client service, and DeckGLMap layer</name>
  <files>
    proto/worldmonitor/positive_events/v1/service.proto
    proto/worldmonitor/positive_events/v1/list_positive_geo_events.proto
    server/worldmonitor/positive-events/v1/handler.ts
    server/worldmonitor/positive-events/v1/list-positive-geo-events.ts
    api/[domain]/v1/[rpc].ts
    vite.config.ts
    src/services/positive-events-geo.ts
    src/components/DeckGLMap.ts
  </files>
  <action>
**1. Create proto definitions (follow unrest service pattern exactly):**

Create `proto/worldmonitor/positive_events/v1/list_positive_geo_events.proto`:
```protobuf
syntax = "proto3";
package worldmonitor.positive_events.v1;

message PositiveGeoEvent {
  double latitude = 1;
  double longitude = 2;
  string name = 3;
  string category = 4;
  int32 count = 5;
  int64 timestamp = 6;  // Unix epoch milliseconds, use INT64_ENCODING_NUMBER
}

message ListPositiveGeoEventsRequest {}

message ListPositiveGeoEventsResponse {
  repeated PositiveGeoEvent events = 1;
}
```

Create `proto/worldmonitor/positive_events/v1/service.proto`:
```protobuf
syntax = "proto3";
package worldmonitor.positive_events.v1;

import "sebuf/http/annotations.proto";
import "worldmonitor/positive_events/v1/list_positive_geo_events.proto";

service PositiveEventsService {
  option (sebuf.http.service_config) = {base_path: "/api/positive-events/v1"};

  rpc ListPositiveGeoEvents(ListPositiveGeoEventsRequest) returns (ListPositiveGeoEventsResponse) {
    option (sebuf.http.config) = {path: "/list-positive-geo-events"};
  }
}
```

Run `cd proto && buf generate` to generate TypeScript client/server stubs.

**2. Create server-side handler (follow unrest handler pattern exactly):**

Create `server/worldmonitor/positive-events/v1/list-positive-geo-events.ts`:
- Import generated types from `src/generated/server/worldmonitor/positive_events/v1/`.
- Import `classifyNewsItem` from `src/services/positive-classifier.ts`.
- Define `GDELT_GEO_URL = 'https://api.gdeltproject.org/api/v2/geo/geo'`.
- Define 2 compound positive queries combining topics from `POSITIVE_GDELT_TOPICS` pattern: Query 1: `"breakthrough OR discovery OR renewable energy"`, Query 2: `"conservation success OR poverty decline OR humanitarian aid"`.
- For each query, fetch GDELT GEO with `timespan=24h`, `maxrecords=75`, `format=geojson`.
- Parse GeoJSON features: extract `[lon, lat]` from `geometry.coordinates`, `name` from `properties.name`, `count` from `properties.count`.
- Filter: skip if `count < 3` (noise filter), skip if invalid coordinates (same validation as unrest handler lines 142-150).
- Deduplicate by location name with `Set<string>` (same pattern as unrest handler lines 128-132).
- Classify each event using `classifyNewsItem('GDELT', name)`.
- Add 500ms delay between the 2 queries (`await new Promise(r => setTimeout(r, 500))`).
- Wrap in try/catch, return empty events array on failure.
- Export `listPositiveGeoEvents` matching the generated handler interface signature.

Create `server/worldmonitor/positive-events/v1/handler.ts`:
```typescript
import type { PositiveEventsServiceHandler } from '../../../../src/generated/server/worldmonitor/positive_events/v1/service_server';
import { listPositiveGeoEvents } from './list-positive-geo-events';

export const positiveEventsHandler: PositiveEventsServiceHandler = {
  listPositiveGeoEvents,
};
```

**3. Register routes (follow unrest registration pattern):**

In `api/[domain]/v1/[rpc].ts`:
- Add import for `createPositiveEventsServiceRoutes` from generated server module.
- Add import for `positiveEventsHandler` from handler module.
- Add route spread: `...createPositiveEventsServiceRoutes(positiveEventsHandler, serverOptions)`.

In `vite.config.ts`:
- Add dynamic import for `positiveEventsServerMod` and `positiveEventsHandlerMod` (same pattern as unrestServerMod/unrestHandlerMod).
- Add route spread in the routes array.

**4. Create `src/services/positive-events-geo.ts` (client-side, calls server RPC):**

Export interface:
```typescript
export interface PositiveGeoEvent {
  lat: number;
  lon: number;
  name: string;
  category: HappyContentCategory;
  count: number;
  timestamp: number;
}
```

Export `fetchPositiveGeoEvents(): Promise<PositiveGeoEvent[]>` that:
- Creates a sebuf client for `PositiveEventsService` (pass `{ fetch: fetch.bind(globalThis) }` per Memory convention).
- Calls `client.listPositiveGeoEvents({})`.
- Maps response events to `PositiveGeoEvent[]` (converting `latitude`/`longitude` to `lat`/`lon`, `category` string to `HappyContentCategory`).
- Wraps in try/catch returning `[]` on failure (graceful degradation).

Also export `geocodePositiveNewsItems(items: Array<{ title: string; category?: HappyContentCategory }>): PositiveGeoEvent[]` that:
- Takes the existing curated RSS items (which have titles from Phase 2/3).
- Calls `inferGeoHubsFromTitle(item.title)` for each item.
- For items with geo matches, creates a `PositiveGeoEvent` with the first match's lat/lon, the item title as name, the item's category (default 'humanity-kindness'), count=1, timestamp=Date.now().
- Returns only items that successfully geocoded (not all RSS items have location mentions).

**5. Update `src/components/DeckGLMap.ts`:**

a) Add private field: `private positiveEvents: PositiveGeoEvent[] = [];` near the other data arrays (line ~271 area).

b) Add `createPositiveEventsLayers(): Layer[]` method following the exact hotspots pulse pattern (lines 2107-2167):
   - **Solid fill layer** (`id: 'positive-events-layer'`):
     - `data: this.positiveEvents`
     - `getPosition: (d) => [d.lon, d.lat]`
     - `getRadius: 15000`
     - `getFillColor`: green `[34, 197, 94, 180]` for nature-wildlife and humanity-kindness categories; gold `[234, 179, 8, 180]` for science-health, innovation-tech, climate-wins; purple `[139, 92, 246, 180]` for culture-community.
     - `radiusMinPixels: 4`, `radiusMaxPixels: 14`
     - `pickable: true`
   - **Pulse ring layer** (`id: 'positive-events-pulse'`):
     - Only for events where `count > 10` (significant events pulse).
     - `radiusScale`: use `1.0 + 0.6 * (0.5 + 0.5 * Math.sin((this.pulseTime || Date.now()) / 500))` (slower than hotspots' 400ms period -- calmer feel).
     - `stroked: true, filled: false`
     - `getLineColor: [34, 197, 94, 100]` (green glow)
     - `lineWidthMinPixels: 1.5`
     - `updateTriggers: { radiusScale: this.pulseTime }`

c) Add tooltip case in `getTooltip()` switch (after existing cases):
```typescript
case 'positive-events-layer':
  return { html: `<div class="deckgl-tooltip"><strong>${text(obj.name)}</strong><br/>${text(obj.category ? obj.category.replace('-', ' & ') : 'Positive Event')}${obj.count > 1 ? ` &bull; ${obj.count} reports` : ''}</div>` };
```

d) In `buildLayers()`, add after the existing layer checks (near the end, before the news locations section):
```typescript
if (mapLayers.positiveEvents && this.positiveEvents.length > 0) {
  layers.push(...this.createPositiveEventsLayers());
}
```

e) Add public setter:
```typescript
public setPositiveEvents(events: PositiveGeoEvent[]): void {
  this.positiveEvents = events;
  this.syncPulseAnimation();
  this.render();
}
```

f) Import `PositiveGeoEvent` type at top of file from `../services/positive-events-geo`.
  </action>
  <verify>Run `cd proto && buf generate` first. Then `npx tsc --noEmit` from project root. Zero TypeScript errors. Verify `grep -c 'createPositiveEventsLayers' src/components/DeckGLMap.ts` returns at least 2 (definition + call in buildLayers). Verify `grep -c 'positiveEventsHandler' server/worldmonitor/positive-events/v1/handler.ts` returns at least 1.</verify>
  <done>Server-side RPC fetches GDELT GEO data for positive queries. Client service calls RPC via sebuf client. DeckGLMap has a working positive events layer with green/gold markers, pulse animation for high-count events, tooltip, and setter. All external API calls go through server-side handlers per codebase convention.</done>
</task>

<task type="auto">
  <name>Task 2: Wire positive events loading into App.ts happy variant pipeline</name>
  <files>src/App.ts</files>
  <action>
1. Import at top of App.ts:
```typescript
import { fetchPositiveGeoEvents, geocodePositiveNewsItems } from './services/positive-events-geo';
```

2. In the `loadAllData()` method (around line 3179), add a new task for happy variant AFTER the natural layer task:
```typescript
if (SITE_VARIANT === 'happy' && this.mapLayers.positiveEvents) {
  tasks.push({ name: 'positiveEvents', task: runGuarded('positiveEvents', () => this.loadPositiveEvents()) });
}
```

3. Create a new private method `loadPositiveEvents()`:
```typescript
private async loadPositiveEvents(): Promise<void> {
  // Source 1: GDELT GEO API positive queries (via server-side RPC)
  const gdeltEvents = await fetchPositiveGeoEvents();

  // Source 2: Geocode curated RSS items from the happy pipeline
  const rssEvents = geocodePositiveNewsItems(
    this.happyAllItems.map(item => ({
      title: item.title,
      category: item.happyCategory,
    }))
  );

  // Merge both sources, deduplicate by name
  const seen = new Set<string>();
  const merged = [...gdeltEvents, ...rssEvents].filter(e => {
    if (seen.has(e.name)) return false;
    seen.add(e.name);
    return true;
  });

  this.map?.setPositiveEvents(merged);
}
```

4. In `loadDataForLayer()` switch statement (around line 3207-3250), add a case:
```typescript
case 'positiveEvents':
  await this.loadPositiveEvents();
  break;
```

This ensures toggling the positiveEvents layer on triggers data loading.
  </action>
  <verify>Run `npx tsc --noEmit` from project root. Zero TypeScript errors. Verify `grep -c 'loadPositiveEvents' src/App.ts` returns at least 3 (definition + 2 call sites).</verify>
  <done>Happy variant loads positive geo events from server-side GDELT GEO RPC + geocoded RSS items on startup and on layer toggle, and pushes them to the map for rendering as green/gold markers.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `grep -c 'PositiveGeoEvent' src/services/positive-events-geo.ts` returns at least 3
3. `grep -c 'createPositiveEventsLayers' src/components/DeckGLMap.ts` returns at least 2
4. `grep -c 'positive-events-layer' src/components/DeckGLMap.ts` returns at least 2 (layer + tooltip)
5. `grep -c 'loadPositiveEvents' src/App.ts` returns at least 3
6. `grep -c 'setPositiveEvents' src/components/DeckGLMap.ts` returns at least 1
7. `grep -c 'listPositiveGeoEvents' server/worldmonitor/positive-events/v1/list-positive-geo-events.ts` returns at least 1
8. `grep -c 'positiveEventsHandler' api/[domain]/v1/[rpc].ts` returns at least 1
</verification>

<success_criteria>
- Proto definition for PositiveEventsService with ListPositiveGeoEvents RPC exists and generates cleanly
- Server-side handler fetches GDELT GEO API with positive topic queries, deduplicates, classifies
- Routes registered in api/[domain]/v1/[rpc].ts and vite.config.ts
- Client service calls server RPC via sebuf client (NOT client-side GDELT fetch)
- RSS items geocoded client-side via inferGeoHubsFromTitle (no external API needed)
- DeckGLMap renders green/gold ScatterplotLayer markers with pulse animation for significant events
- Tooltip shows event name, category, and count on hover
- App.ts loads positive events for happy variant in loadAllData() and on layer toggle
- Data loads asynchronously without blocking map render
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/04-global-map-positive-events/04-02-SUMMARY.md`
</output>
