---
phase: 04-global-map-positive-events
plan: 03
type: execute
wave: 3
depends_on: [04-01, 04-02]
files_modified:
  - src/services/kindness-data.ts
  - src/components/DeckGLMap.ts
  - src/App.ts
autonomous: true
requirements: [KIND-01, KIND-02]

must_haves:
  truths:
    - "The map shows animated green pulsing dots representing acts of kindness worldwide on the happy variant"
    - "Kindness layer combines synthetic baseline points (50-80 from major cities weighted by population) with real kindness events extracted from the positive news pipeline"
    - "Baseline kindness points regenerate every 5 minutes with slight position jitter so the map feels alive"
    - "Clicking a kindness marker shows a tooltip with city name and description"
    - "Kindness layer respects the kindness toggle (can be turned off)"
  artifacts:
    - path: "src/services/kindness-data.ts"
      provides: "Kindness data pipeline: baseline generator + curated event extraction"
      exports: ["fetchKindnessData", "KindnessPoint"]
    - path: "src/components/DeckGLMap.ts"
      provides: "createKindnessLayers method, tooltip case, setter, buildLayers wiring"
      contains: "createKindnessLayers"
    - path: "src/App.ts"
      provides: "Happy variant kindness data loading on startup and refresh"
      contains: "loadKindnessData"
  key_links:
    - from: "src/services/kindness-data.ts"
      to: "src/components/DeckGLMap.ts"
      via: "App.ts calls fetchKindnessData() then map.setKindnessData()"
      pattern: "setKindnessData"
    - from: "src/components/DeckGLMap.ts"
      to: "buildLayers"
      via: "mapLayers.kindness check gates createKindnessLayers()"
      pattern: "mapLayers\\.kindness"
---

<objective>
Build the kindness data pipeline (population-weighted baseline + curated events) and Deck.gl animated layer showing acts of kindness worldwide as green pulses.

Purpose: KIND-01 and KIND-02 -- the emotional heart of the happy map. Green pulses make the world feel warm and active with goodness, even when real event data is sparse.
Output: Working kindness layer with 50-80 baseline pulses + real kindness events from curated feeds.
</objective>

<execution_context>
@/Users/sebastienmelki/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastienmelki/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-global-map-positive-events/04-RESEARCH.md
@.planning/phases/04-global-map-positive-events/04-01-SUMMARY.md
@.planning/phases/04-global-map-positive-events/04-02-SUMMARY.md
@src/components/DeckGLMap.ts (lines 2107-2167 -- createHotspotsLayers pulse pattern)
@src/components/DeckGLMap.ts (lines 2192-2254 -- pulse animation system)
@src/services/positive-classifier.ts (HappyContentCategory)
@src/services/positive-events-geo.ts (PositiveGeoEvent -- created in Plan 02)
@src/App.ts (happy variant loading pipeline)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create kindness-data service with baseline generator and curated event extraction</name>
  <files>src/services/kindness-data.ts</files>
  <action>
Create `src/services/kindness-data.ts` exporting:

**1. Interface:**
```typescript
export interface KindnessPoint {
  lat: number;
  lon: number;
  name: string;
  description: string;
  intensity: number;      // 0-1, higher = more prominent on map
  type: 'baseline' | 'real';
  timestamp: number;
}
```

**2. MAJOR_CITIES constant** -- a curated array of ~60 major world cities with lat/lon and population (for density weighting). Include:
- Top 15 by population: Tokyo, Delhi, Shanghai, Sao Paulo, Mexico City, Cairo, Mumbai, Beijing, Dhaka, Osaka, New York, Karachi, Buenos Aires, Istanbul, Lagos
- 15 European: London, Paris, Berlin, Madrid, Rome, Amsterdam, Stockholm, Vienna, Warsaw, Prague, Brussels, Dublin, Lisbon, Zurich, Helsinki
- 10 Asian: Seoul, Bangkok, Jakarta, Manila, Singapore, Kuala Lumpur, Taipei, Hong Kong, Hanoi, Ho Chi Minh City
- 10 Americas: Los Angeles, Chicago, Toronto, Bogota, Lima, Santiago, Montreal, Vancouver, San Francisco, Miami
- 10 Africa/Middle East/Oceania: Nairobi, Johannesburg, Dubai, Riyadh, Tel Aviv, Casablanca, Sydney, Melbourne, Auckland, Cape Town

Each entry: `{ name: string; lat: number; lon: number; population: number }` where population is approximate in millions.

**3. `generateBaselineKindness(): KindnessPoint[]`** (not exported):
- For each city, calculate a weight: `Math.min(1, city.population / 30)` (population in millions / 30M).
- Randomly include each city with probability based on weight (more populous = more likely to appear).
- Target 50-80 points total. If over 80, randomly trim. If under 50, fill from remaining cities.
- For each included city, jitter lat/lon by `(Math.random() - 0.5) * 0.3` (stays within city region).
- Set `name` to city name, `description` to one of 5 rotating positive phrases: "Community helping neighbors", "Volunteers at work", "Donations flowing", "Random acts of kindness", "People making a difference".
- Set `intensity = Math.min(1, city.population / 20)`.
- Set `type: 'baseline'`, `timestamp: Date.now() - Math.random() * 3600_000` (random time within last hour).
- Use a simple seeded-ish approach: `Math.random()` is fine (regenerates every 5 min so determinism not critical).

**4. `extractKindnessEvents(newsItems: Array<{ title: string; happyCategory?: string }>): KindnessPoint[]`** (not exported):
- Filter items where `happyCategory === 'humanity-kindness'`.
- For each, call `inferGeoHubsFromTitle(item.title)` to try geocoding.
- For items with geo matches, create a `KindnessPoint` with first match lat/lon, the title as name, description as title, intensity=0.8, type='real', timestamp=Date.now().
- Return only successfully geocoded items.

**5. `fetchKindnessData(newsItems?: Array<{ title: string; happyCategory?: string }>): KindnessPoint[]`** (exported):
- Calls `generateBaselineKindness()` for synthetic points.
- If `newsItems` provided, calls `extractKindnessEvents(newsItems)` for real events.
- Merges both arrays with real events first (they render on top).
- Returns merged array.
- This is synchronous (no API calls) -- baseline is generated locally, real events come from already-fetched news items.

Import `inferGeoHubsFromTitle` from `./geo-hub-index`.
  </action>
  <verify>Run `npx tsc --noEmit` from project root. Zero TypeScript errors. Verify `grep -c 'KindnessPoint' src/services/kindness-data.ts` returns at least 5.</verify>
  <done>Kindness data service generates 50-80 baseline points from major cities + extracts real kindness events from news items via geocoding. No external API calls needed.</done>
</task>

<task type="auto">
  <name>Task 2: Add kindness layer to DeckGLMap and wire into App.ts loading pipeline</name>
  <files>
    src/components/DeckGLMap.ts
    src/App.ts
  </files>
  <action>
**DeckGLMap.ts changes:**

1. Add private field: `private kindnessPoints: KindnessPoint[] = [];` near the positiveEvents field.

2. Add `createKindnessLayers(): Layer[]` method following the pulse pattern:
   - **Solid fill layer** (`id: 'kindness-layer'`):
     - `data: this.kindnessPoints`
     - `getPosition: (d) => [d.lon, d.lat]`
     - `getRadius: (d) => 8000 + d.intensity * 12000` (smaller than positive events -- subtle background)
     - `getFillColor: (d) => d.type === 'real' ? [74, 222, 128, 200] : [74, 222, 128, 100]` (real events more opaque, baseline semi-transparent)
     - `radiusMinPixels: 3`, `radiusMaxPixels: 10`
     - `pickable: true` (for tooltips on real events)
   - **Pulse ring layer** (`id: 'kindness-pulse'`):
     - Only for `type === 'real'` items (real events pulse, baseline does not).
     - `radiusScale`: `1.0 + 0.5 * (0.5 + 0.5 * Math.sin((this.pulseTime || Date.now()) / 600))` (slowest pulse -- gentle, calming).
     - `stroked: true, filled: false`
     - `getLineColor: [74, 222, 128, 80]` (soft green glow)
     - `lineWidthMinPixels: 1`
     - `updateTriggers: { radiusScale: this.pulseTime }`

3. Add tooltip case in `getTooltip()` switch:
```typescript
case 'kindness-layer':
  return { html: `<div class="deckgl-tooltip"><strong>${text(obj.name)}</strong><br/>${text(obj.description || 'Acts of kindness nearby')}</div>` };
```

4. In `buildLayers()`, add after the positiveEvents block (added in Plan 02):
```typescript
if (mapLayers.kindness && this.kindnessPoints.length > 0) {
  layers.push(...this.createKindnessLayers());
}
```

5. Add public setter:
```typescript
public setKindnessData(points: KindnessPoint[]): void {
  this.kindnessPoints = points;
  this.syncPulseAnimation();
  this.render();
}
```

6. Import `KindnessPoint` type from `../services/kindness-data`.

**App.ts changes:**

1. Import at top:
```typescript
import { fetchKindnessData } from './services/kindness-data';
```

2. In `loadAllData()`, add task for happy variant (near the positiveEvents task added in Plan 02):
```typescript
if (SITE_VARIANT === 'happy' && this.mapLayers.kindness) {
  tasks.push({ name: 'kindness', task: runGuarded('kindness', () => this.loadKindnessData()) });
}
```

3. Create private method:
```typescript
private loadKindnessData(): void {
  const kindnessItems = fetchKindnessData(
    this.happyAllItems.map(item => ({
      title: item.title,
      happyCategory: item.happyCategory,
    }))
  );
  this.map?.setKindnessData(kindnessItems);
}
```

Note: this is synchronous (no await needed) since fetchKindnessData does no API calls.

4. In `loadDataForLayer()` switch, add:
```typescript
case 'kindness':
  this.loadKindnessData();
  break;
```

5. To make baseline regenerate every 5 minutes (per research recommendation), the existing refresh interval in the happy variant already re-runs `loadData()` which will call `loadKindnessData()` again. The baseline generator uses `Math.random()` so each call produces slightly different points, creating the "alive" feeling. No additional timer needed.
  </action>
  <verify>Run `npx tsc --noEmit` from project root. Zero TypeScript errors. Verify `grep -c 'createKindnessLayers' src/components/DeckGLMap.ts` returns at least 2. Verify `grep -c 'loadKindnessData' src/App.ts` returns at least 3.</verify>
  <done>Kindness layer renders 50-80 green baseline pulses worldwide plus real kindness events from curated feeds. Baseline regenerates on each refresh cycle. Real events pulse gently. The happy map feels alive with global goodwill.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `grep -c 'KindnessPoint' src/services/kindness-data.ts` returns at least 5
3. `grep -c 'createKindnessLayers' src/components/DeckGLMap.ts` returns at least 2
4. `grep -c 'kindness-layer' src/components/DeckGLMap.ts` returns at least 2 (layer + tooltip)
5. `grep -c 'loadKindnessData' src/App.ts` returns at least 3
6. `grep -c 'setKindnessData' src/components/DeckGLMap.ts` returns at least 1
7. `grep -c 'MAJOR_CITIES' src/services/kindness-data.ts` returns at least 2
</verification>

<success_criteria>
- Kindness data service generates 50-80 baseline points from ~60 major cities weighted by population
- Real kindness events extracted from curated news items via geocoding
- DeckGLMap renders green ScatterplotLayer with subtle semi-transparent baseline dots and brighter real events
- Real kindness events pulse gently (600ms period)
- Tooltip shows city name and description on hover
- App.ts loads kindness data for happy variant on startup and refresh
- Baseline regenerates each refresh cycle with slight position variation
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/04-global-map-positive-events/04-03-SUMMARY.md`
</output>
