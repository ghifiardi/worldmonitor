---
phase: 03-positive-news-feed-quality-pipeline
plan: 03
type: execute
wave: 2
depends_on: [03-01, 03-02]
files_modified:
  - src/services/sentiment-gate.ts
  - src/App.ts
  - src/config/variants/happy.ts
autonomous: true
requirements: [NEWS-03, FEED-02, FEED-05]

must_haves:
  truths:
    - "Curated positive feeds render immediately without waiting for ML model"
    - "GDELT positive-tone articles pass through DistilBERT-SST2 sentiment filtering before appearing"
    - "Only GDELT articles with positive label AND score >= configurable threshold (default 0.85) appear"
    - "If ML worker is unavailable or model fails to load, curated feeds still show (graceful degradation)"
    - "The feed auto-refreshes on the configured interval (REFRESH_INTERVALS.feeds) with filter state preserved"
    - "Curated items appear first in the merged feed, with GDELT supplementary items interleaved by date"
    - "The PositiveNewsFeedPanel is wired into App.ts as the primary panel for happy variant"
  artifacts:
    - path: "src/services/sentiment-gate.ts"
      provides: "Sentiment filtering service using mlWorker.classifySentiment"
      exports: ["filterBySentiment"]
      min_lines: 20
    - path: "src/App.ts"
      provides: "Happy variant news pipeline: curated + sentiment-filtered GDELT, rendered in PositiveNewsFeedPanel"
      contains: "PositiveNewsFeedPanel"
    - path: "src/config/variants/happy.ts"
      provides: "Panel registration with positive-feed replacing live-news"
      contains: "positive-feed"
  key_links:
    - from: "src/services/sentiment-gate.ts"
      to: "src/services/ml-worker.ts"
      via: "mlWorker.classifySentiment() for batch sentiment inference"
      pattern: "mlWorker\\.classifySentiment"
    - from: "src/App.ts loadNews() happy branch"
      to: "src/services/sentiment-gate.ts"
      via: "filterBySentiment() on GDELT articles"
      pattern: "filterBySentiment"
    - from: "src/App.ts loadNews() happy branch"
      to: "src/services/gdelt-intel.ts"
      via: "fetchAllPositiveTopicIntelligence() for supplementary content"
      pattern: "fetchAllPositiveTopicIntelligence\\|fetchPositiveGdeltArticles"
    - from: "src/App.ts createPanels()"
      to: "src/components/PositiveNewsFeedPanel.ts"
      via: "new PositiveNewsFeedPanel() instantiation"
      pattern: "new PositiveNewsFeedPanel"
    - from: "src/config/variants/happy.ts"
      to: "src/App.ts createPanels()"
      via: "HAPPY_PANELS 'positive-feed' key drives panel ordering loop"
      pattern: "positive-feed"
    - from: "src/App.ts loadNews() happy branch"
      to: "PositiveNewsFeedPanel.renderPositiveNews()"
      via: "passes merged curated+GDELT items to panel"
      pattern: "renderPositiveNews"
---

<objective>
Wire the multi-stage quality pipeline: curated feeds as primary content (no ML gating), GDELT positive-tone articles as ML-sentiment-filtered supplement, merged into a unified feed rendered by PositiveNewsFeedPanel. Also wire auto-refresh and the panel into App.ts.

Purpose: This completes the Phase 3 feature set by connecting all the pieces -- the panel (Plan 02), the App.ts integration (Plan 01), the existing ML worker, the existing GDELT positive fetcher, and the existing curated RSS feeds -- into a cohesive pipeline that prioritizes curated content and supplements it with ML-verified mainstream news.

Output: A complete, working positive news experience on the happy variant with auto-refresh and multi-stage quality pipeline.
</objective>

<execution_context>
@/Users/sebastienmelki/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastienmelki/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-positive-news-feed-quality-pipeline/03-RESEARCH.md
@.planning/phases/03-positive-news-feed-quality-pipeline/03-01-SUMMARY.md
@.planning/phases/03-positive-news-feed-quality-pipeline/03-02-SUMMARY.md
@src/App.ts
@src/services/ml-worker.ts
@src/services/gdelt-intel.ts
@src/services/rss.ts
@src/components/PositiveNewsFeedPanel.ts
@src/services/positive-classifier.ts
@src/config/feeds.ts
@src/config/variants/happy.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sentiment gate service for ML-based filtering</name>
  <files>src/services/sentiment-gate.ts</files>
  <action>
Create a new service module `src/services/sentiment-gate.ts` that wraps the existing `mlWorker.classifySentiment()` for filtering news items by positive sentiment.

**Exports:**

```typescript
import { mlWorker } from './ml-worker';
import type { NewsItem } from '@/types';

const DEFAULT_THRESHOLD = 0.85;
const BATCH_SIZE = 20; // ML_THRESHOLDS.maxTextsPerBatch from ml-config.ts

/**
 * Filter news items by positive sentiment using DistilBERT-SST2.
 * Returns only items classified as positive with score >= threshold.
 *
 * Graceful degradation:
 * - If mlWorker is not ready/available, returns all items unfiltered
 * - If classification fails, returns all items unfiltered
 * - Batches titles to respect ML worker limits
 *
 * @param items - News items to filter
 * @param threshold - Minimum positive confidence score (default 0.85)
 * @returns Items passing the sentiment filter
 */
export async function filterBySentiment(
  items: NewsItem[],
  threshold = DEFAULT_THRESHOLD
): Promise<NewsItem[]> {
  if (items.length === 0) return [];

  // Check localStorage override for threshold tuning during development
  try {
    const override = localStorage.getItem('positive-threshold');
    if (override) {
      const parsed = parseFloat(override);
      if (!isNaN(parsed) && parsed >= 0 && parsed <= 1) {
        threshold = parsed;
        console.log(`[SentimentGate] Using override threshold: ${threshold}`);
      }
    }
  } catch { /* ignore localStorage errors */ }

  // Graceful degradation: if ML not available, pass all items through
  try {
    const ready = await mlWorker.init();
    if (!ready) {
      console.log('[SentimentGate] ML worker not available, passing all items through');
      return items;
    }
  } catch {
    console.log('[SentimentGate] ML worker init failed, passing all items through');
    return items;
  }

  try {
    const titles = items.map(item => item.title);
    const allResults: Array<{ label: string; score: number }> = [];

    // Batch to avoid overwhelming the worker
    for (let i = 0; i < titles.length; i += BATCH_SIZE) {
      const batch = titles.slice(i, i + BATCH_SIZE);
      const batchResults = await mlWorker.classifySentiment(batch);
      allResults.push(...batchResults);
    }

    const passed = items.filter((_, idx) => {
      const result = allResults[idx];
      return result && result.label === 'positive' && result.score >= threshold;
    });

    console.log(`[SentimentGate] ${passed.length}/${items.length} items passed (threshold=${threshold})`);
    return passed;
  } catch (err) {
    console.warn('[SentimentGate] Sentiment classification failed, passing all items through:', err);
    return items;
  }
}
```

**Key design decisions per research:**
- `DEFAULT_THRESHOLD = 0.85` -- hypothesis from STATE.md. Tunable via localStorage `positive-threshold` key for experimentation.
- Graceful degradation at every level: worker not ready, init fails, classification fails -- always returns items rather than empty array.
- Batches at 20 items per call (matches ML_THRESHOLDS.maxTextsPerBatch).
- Logging pass rate to console for threshold tuning during development.
- Uses `mlWorker.init()` which is idempotent -- safe to call even if already initialized.
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. `grep -n "filterBySentiment" src/services/sentiment-gate.ts` shows the exported function
3. `grep -n "mlWorker.classifySentiment" src/services/sentiment-gate.ts` shows the ML worker integration
4. `grep -n "DEFAULT_THRESHOLD" src/services/sentiment-gate.ts` shows 0.85
  </verify>
  <done>
Sentiment gate service exports `filterBySentiment(items, threshold?)` that batches titles through DistilBERT-SST2, returns only positive items above threshold, and degrades gracefully when ML is unavailable.
  </done>
</task>

<task type="auto">
  <name>Task 2: Register positive-feed panel and wire multi-stage pipeline into App.ts</name>
  <files>src/config/variants/happy.ts, src/App.ts</files>
  <action>
This task wires everything together: registers the panel in HAPPY_PANELS config and connects the multi-stage news pipeline in App.ts.

**Step 1: Register 'positive-feed' in HAPPY_PANELS (src/config/variants/happy.ts)**

In `src/config/variants/happy.ts`, replace the `'live-news'` entry in `DEFAULT_PANELS` with `'positive-feed'`:

```typescript
// BEFORE:
'live-news': { name: 'Good News', enabled: true, priority: 1 },

// AFTER:
'positive-feed': { name: 'Good News Feed', enabled: true, priority: 1 },
```

This ensures the panel ordering loop in `createPanels()` picks up the PositiveNewsFeedPanel automatically. The key `'positive-feed'` replaces `'live-news'` so the happy variant renders the new unified panel instead of the old live-news panel.

**Step 2: Add imports at top of App.ts**

Add these imports (alongside existing imports):
```typescript
import { PositiveNewsFeedPanel } from '@/components/PositiveNewsFeedPanel';
import { filterBySentiment } from '@/services/sentiment-gate';
import { fetchAllPositiveTopicIntelligence } from '@/services/gdelt-intel';
```

Note: `fetchAllPositiveTopicIntelligence` might already be imported from Phase 2 -- check and only add if missing. Same for `classifyNewsItem` (already imported from 02-03).

**Step 3: Add positivePanel property**

Add to the class properties (near the other panel declarations):
```typescript
private positivePanel: PositiveNewsFeedPanel | null = null;
```

**Step 4: Create PositiveNewsFeedPanel in createPanels()**

In the `createPanels()` method, add happy variant panel creation. Place this in the happy-specific section (Plan 01 added conditional blocks). When `SITE_VARIANT === 'happy'`:

```typescript
if (SITE_VARIANT === 'happy') {
  this.positivePanel = new PositiveNewsFeedPanel();
  this.panels['positive-feed'] = this.positivePanel;
}
```

The panel ordering system reads from `DEFAULT_PANELS` keys (now including `'positive-feed'` from Step 1), so the PositiveNewsFeedPanel will be positioned in the grid automatically.

**Step 5: Wire loadNews() happy branch for multi-stage pipeline**

Add a class property for accumulating items: `private happyAllItems: NewsItem[] = [];`

At the beginning of `loadNews()`, reset the accumulator:
```typescript
if (SITE_VARIANT === 'happy') {
  this.happyAllItems = [];
}
```

In `loadNewsCategory()`, after the existing happyCategory tagging block (~line 3384-3388), accumulate items:
```typescript
if (SITE_VARIANT === 'happy') {
  this.happyAllItems = this.happyAllItems.concat(items);
}
```

After all category loads complete in `loadNews()`, call the pipeline:
```typescript
if (SITE_VARIANT === 'happy') {
  await this.loadHappySupplementaryAndRender();
}
```

**Step 6: Implement loadHappySupplementaryAndRender()**

```typescript
private async loadHappySupplementaryAndRender(): Promise<void> {
  if (!this.positivePanel) return;

  // Stage 1: Curated items already accumulated in happyAllItems
  const curated = [...this.happyAllItems];

  // Render curated immediately (non-blocking UX -- never wait for ML)
  this.positivePanel.renderPositiveNews(curated);

  // Stage 2: Load GDELT positive articles as supplementary content
  let supplementary: NewsItem[] = [];
  try {
    const gdeltTopics = await fetchAllPositiveTopicIntelligence();
    const gdeltItems: NewsItem[] = gdeltTopics.flatMap(topic =>
      topic.articles.map(article => ({
        source: 'GDELT',
        title: article.title,
        link: article.url,
        pubDate: new Date(article.seenDate || Date.now()),
        isAlert: false,
        imageUrl: article.socialImage || undefined,
        happyCategory: classifyNewsItem('GDELT', article.title),
      }))
    );

    // Stage 3: Sentiment-filter GDELT articles
    supplementary = await filterBySentiment(gdeltItems);
  } catch (err) {
    console.warn('[App] Happy supplementary pipeline failed, using curated only:', err);
  }

  // Stage 4: Merge curated + supplementary, sorted by date, re-render
  if (supplementary.length > 0) {
    const merged = [...curated, ...supplementary];
    merged.sort((a, b) => b.pubDate.getTime() - a.pubDate.getTime());
    this.positivePanel.renderPositiveNews(merged);
  }
}
```

Check the GDELT article shape -- `GdeltArticle` from gdelt-intel.ts has `title`, `url`, `seenDate`, and `socialImage`. Map `socialImage` to `imageUrl`.

**Step 7: Ensure auto-refresh works (NEWS-03)**

Plan 01 already set up `this.scheduleRefresh('news', () => this.loadNews(), REFRESH_INTERVALS.feeds)` for happy variant. The `loadNews()` flow now includes the happy pipeline, so auto-refresh automatically triggers the full pipeline on each interval. Filter state in PositiveNewsFeedPanel is preserved because `renderPositiveNews()` calls `applyFilter()` which uses the stored `activeFilter`.

The two-phase render approach (curated immediate, supplementary async) means users see content immediately, and GDELT supplements appear a few seconds later when ML completes.
  </action>
  <verify>
1. `npx tsc --noEmit` passes with all new imports and wiring
2. `grep -n "positive-feed" src/config/variants/happy.ts` shows the panel registration (replacing live-news)
3. `grep -n "PositiveNewsFeedPanel" src/App.ts` shows import and instantiation
4. `grep -n "filterBySentiment" src/App.ts` shows sentiment gate usage
5. `grep -n "loadHappySupplementaryAndRender" src/App.ts` shows the pipeline method
6. `grep -n "happyAllItems" src/App.ts` shows item accumulation
7. `grep -n "fetchAllPositiveTopicIntelligence\\|fetchPositiveGdeltArticles" src/App.ts` shows GDELT integration
8. `VITE_VARIANT=happy npx vite build` succeeds (full build test)
  </verify>
  <done>
Happy variant has 'positive-feed' registered in HAPPY_PANELS (replacing 'live-news'), and App.ts has a complete multi-stage news pipeline: (1) curated RSS feeds load and render immediately in PositiveNewsFeedPanel, (2) GDELT positive articles are fetched and sentiment-filtered asynchronously, (3) supplementary items merge into the feed sorted by date. Auto-refresh on REFRESH_INTERVALS.feeds re-runs the entire pipeline with filter state preserved. ML unavailability degrades gracefully to curated-only display.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npx tsc --noEmit` -- full project type-checks
2. `VITE_VARIANT=happy npx vite build` -- production build succeeds
3. `grep -n "positive-feed" src/config/variants/happy.ts` -- panel registered, live-news replaced
4. The pipeline flow: RSS curated -> immediate render -> GDELT fetch -> sentiment filter -> merged render
5. Console logs show `[SentimentGate] X/Y items passed` during GDELT processing
6. If ML worker is disabled (e.g., unsupported browser), curated feeds still render
7. Auto-refresh triggers on REFRESH_INTERVALS.feeds interval and re-runs full pipeline
</verification>

<success_criteria>
- 'positive-feed' is registered in HAPPY_PANELS in happy.ts, replacing 'live-news'
- PositiveNewsFeedPanel is instantiated and positioned in App.ts for happy variant
- Curated feeds render immediately without waiting for ML (non-blocking UX)
- GDELT supplementary articles go through filterBySentiment() with 0.85 default threshold
- Merged feed shows curated first, supplementary interleaved by date
- Auto-refresh on configurable interval re-runs full pipeline
- Sentiment threshold is tunable via localStorage 'positive-threshold' for experimentation
- ML failure degrades gracefully to curated-only display
- No changes to full/tech/finance variant behavior
</success_criteria>

<output>
After completion, create `.planning/phases/03-positive-news-feed-quality-pipeline/03-03-SUMMARY.md`
</output>
